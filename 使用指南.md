# 🎯 WireGuard 分流功能使用指南

## 📌 快速开始

### 前置条件

1. ✅ 已安装 Docker 和 Docker Compose
2. ✅ 拥有一个可用的上游 WireGuard 服务器（可选）
3. ✅ 基本的 WireGuard 使用经验

---

## 🚀 步骤 1: 构建和启动

```bash
# 进入 wg-easy 目录
cd /workspace

# 构建新镜像
docker compose build

# 启动服务
docker compose up -d

# 查看启动日志
docker logs -f wg-easy

# 看到以下日志表示成功:
# [SplitTunneling] Initializing Split Tunneling...
# [SplitTunneling] Split Tunneling initialized successfully.
```

---

## 🎯 步骤 2: 配置上游服务器

### 2.1 生成本地密钥

```bash
# 在你的本地机器上生成密钥对
wg genkey | tee privatekey | wg pubkey > publickey

# 查看密钥
cat privatekey  # 本地私钥 (填入 wg-easy)
cat publickey   # 本地公钥 (填入上游服务器)
```

### 2.2 配置上游服务器

**在你的上游 WireGuard 服务器上添加 Peer**:

```ini
# /etc/wireguard/wg0.conf (上游服务器)
[Peer]
PublicKey = <本地公钥_from_上面>
AllowedIPs = 10.8.0.0/24  # 允许 wg-easy 的客户端网段
```

然后重载配置：
```bash
wg syncconf wg0 <(wg-quick strip wg0)
```

### 2.3 在 wg-easy UI 中创建上游

1. 访问 `http://your-server:51821`
2. 登录管理后台
3. 进入 **Admin Panel**
4. 点击侧边栏的 **Upstream Servers** (新增菜单)
5. 点击 **Add Upstream Server**
6. 填写表单：
   - **Name**: US Server
   - **Endpoint**: your-upstream.com:51820
   - **Upstream Public Key**: (上游服务器的公钥)
   - **Local Private Key**: (刚才生成的本地私钥)
   - **Allowed IPs**: 0.0.0.0/0
   - **Persistent Keepalive**: 25
   - **MTU**: 1360
   - **Enabled**: ✓
7. 点击 **Create**

---

## 🎨 步骤 3: 配置客户端分流

### 3.1 编辑客户端

1. 在主页面点击客户端卡片
2. 滚动到 **Split Tunneling** 区域
3. 启用 **Enable Split Tunneling** 开关
4. 在下拉菜单中选择上游服务器（如 US Server）

### 3.2 添加分流规则

**在 Routing Rules 区域**:

1. 选择规则类型：
   - **Domain** - 域名规则
   - **IP/CIDR** - IP 地址规则

2. 输入值：
   - 域名示例: `google.com` 或 `*.google.com`
   - IP 示例: `8.8.8.8` 或 `8.8.8.0/24`

3. 选择动作：
   - **Proxy** - 通过上游服务器
   - **Direct** - 直接连接

4. 点击 **Add Rule**

### 3.3 常用规则示例

```
# Google 服务
google.com        → Domain → Proxy
*.google.com      → Domain → Proxy
gstatic.com       → Domain → Proxy
googleapis.com    → Domain → Proxy

# 社交媒体
twitter.com       → Domain → Proxy
facebook.com      → Domain → Proxy
instagram.com     → Domain → Proxy

# 特定 IP
8.8.8.8           → IP     → Proxy
1.1.1.1           → IP     → Proxy

# IP 段
8.8.8.0/24        → IP     → Proxy
```

---

## 📱 步骤 4: 配置客户端设备

### 4.1 下载客户端配置

1. 在 wg-easy UI 中点击客户端的二维码图标
2. 扫描二维码或下载配置文件

### 4.2 重要：设置 DNS

**确保客户端配置中 DNS 指向 wg-easy 服务器**:

```ini
[Interface]
PrivateKey = xxx
Address = 10.8.0.2/24
DNS = 10.8.0.1    ← 这一行非常重要！必须设置！

[Peer]
PublicKey = xxx
Endpoint = your-wg-easy:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
```

### 4.3 连接测试

```bash
# 启动 WireGuard
wg-quick up client

# 测试直连（应该显示本地 IP）
curl ipinfo.io/ip

# 测试域名（如果配置了 google.com 走代理）
curl https://google.com -I
# 或访问浏览器查看

# 测试 DNS
nslookup google.com
# 应该显示 10.8.0.1 作为 DNS 服务器
```

---

## 🎯 使用场景示例

### 场景 1: 企业员工访问 Google Workspace

**配置**:
```
上游服务器: US-Office (美国节点)

客户端规则:
  google.com         → Proxy
  *.google.com       → Proxy  
  gmail.com          → Proxy
  drive.google.com   → Proxy
  docs.google.com    → Proxy
  
其他域名           → Direct (自动)
```

**效果**: 
- 访问 Google 服务快速稳定
- 访问公司内网直连
- 访问本地网站快速

---

### 场景 2: 开发者测试不同地区

**配置**:

**客户端 A (模拟美国用户)**:
```
上游: US Server
规则: * → Proxy (所有流量走美国)
```

**客户端 B (模拟欧洲用户)**:
```
上游: EU Server  
规则: * → Proxy (所有流量走欧洲)
```

**客户端 C (本地测试)**:
```
上游: 禁用
规则: 无 (所有流量直连)
```

**效果**: 快速切换不同的测试环境

---

### 场景 3: 家庭网络优化

**配置**:

**儿童设备**:
```
上游: Educational Server
规则:
  youtube.com      → Proxy (教育视频)
  wikipedia.org    → Proxy
  其他             → Direct
```

**成人设备**:
```
上游: Work Server
规则:
  company-vpn.com  → Proxy
  google.com       → Proxy
  其他             → Direct
```

**智能设备**:
```
上游: 禁用 (全部直连)
```

---

## 🔍 监控和管理

### 查看分流状态

**通过 API**:
```bash
curl http://localhost:51821/api/splitTunneling/status \
  -H "Cookie: session=xxx"
```

**通过命令行**:
```bash
docker exec wg-easy bash -c '
echo "=== Upstream Interfaces ==="
wg show | grep interface

echo -e "\n=== Active Rules ==="
cat /etc/dnsmasq.d/split-tunneling.conf

echo -e "\n=== Client ipsets ==="
ipset list -n | grep client_

echo -e "\n=== Policy Routes ==="
ip rule list | grep fwmark
'
```

### 实时监控

```bash
# 监控上游流量
docker exec wg-easy watch -n 1 'wg show all brief'

# 监控 ipset 变化
docker exec wg-easy watch -n 1 'ipset list client_1_proxy'

# 监控 iptables 计数
docker exec wg-easy watch -n 1 'iptables -t mangle -L PREROUTING -n -v'
```

---

## 🔧 常用管理操作

### 添加/删除上游服务器

**通过 UI**: Admin Panel → Upstream Servers → Add/Delete

**通过 API**:
```bash
# 创建上游
curl -X POST http://localhost:51821/api/upstream \
  -H "Content-Type: application/json" \
  -d '{
    "name": "New Server",
    "endpoint": "server.com:51820",
    "publicKey": "xxx",
    "privateKey": "yyy",
    "allowedIps": ["0.0.0.0/0"]
  }'

# 删除上游
curl -X DELETE http://localhost:51821/api/upstream/1
```

### 添加/删除分流规则

**通过 UI**: Clients → Edit → Split Tunneling → Add Rule

**通过 API**:
```bash
# 添加规则
curl -X POST http://localhost:51821/api/splitRule/1 \
  -H "Content-Type: application/json" \
  -d '{
    "ruleType": "domain",
    "ruleValue": "google.com",
    "action": "proxy"
  }'

# 删除规则
curl -X DELETE http://localhost:51821/api/splitRule/1/1
```

---

## 📊 性能优化建议

### 1. MTU 调整

```
主接口 (wg0):      1420
上游接口 (wg-up-X): 1360  ← 减少 60 字节避免分片
```

### 2. ipset 超时

```bash
# 调整 ipset 超时时间（秒）
# 默认 3600 (1小时)
# 可调整为 7200 (2小时) 减少 DNS 查询
```

### 3. dnsmasq 缓存

```bash
# 在 /etc/dnsmasq.conf 添加
cache-size=10000    # 增大缓存
```

### 4. 系统参数

```bash
# 在容器中运行
sysctl -w net.ipv4.tcp_congestion_control=bbr
sysctl -w net.netfilter.nf_conntrack_max=1000000
```

---

## 🐛 常见问题解决

### Q1: 分流不生效

**检查清单**:
- [ ] 客户端 DNS 是否设置为 10.8.0.1？
- [ ] dnsmasq 是否运行？(`docker exec wg-easy pgrep dnsmasq`)
- [ ] 规则是否保存到数据库？
- [ ] ipset 是否有内容？(`docker exec wg-easy ipset list client_1_proxy`)
- [ ] 上游接口是否启动？(`docker exec wg-easy wg show wg-up-1`)

### Q2: 所有流量都走代理

**原因**: 可能配置了过于宽泛的规则（如 *）

**解决**: 删除宽泛规则，只添加需要代理的域名/IP

### Q3: 性能下降明显

**检查**:
- MTU 是否设置正确（上游 1360）
- 是否有过多的规则（建议 <100 条/客户端）
- 上游服务器是否稳定

### Q4: 客户端无法连接

**检查**:
- wg0 主接口是否正常
- 防火墙规则是否正确
- 客户端配置是否正确（特别是 DNS）

---

## 💡 最佳实践

### 规则设计

✅ **DO**:
- 使用域名规则而非 IP（IP 可能变化）
- 规则数量控制在 100 条以内/客户端
- 使用描述性的上游服务器名称
- 定期审查和清理无用规则

❌ **DON'T**:
- 不要使用过于宽泛的规则（如 `*`）
- 不要添加大量 IP 规则（影响性能）
- 不要忘记设置客户端 DNS
- 不要在生产环境直接测试

### 上游服务器管理

✅ **建议**:
- 为每个地区/用途使用不同的上游
- 定期检查上游连接状态
- 为关键服务准备备用上游
- 监控上游流量和延迟

### 安全考虑

✅ **注意**:
- 定期更新 WireGuard 密钥
- 限制管理员权限
- 启用 2FA
- 审计配置变更
- 监控异常流量

---

## 📈 监控指标

### 关键指标

| 指标 | 查看方法 |
|------|---------|
| 上游连接状态 | `wg show wg-up-1` |
| 客户端数量 | UI 主页面 |
| 分流规则数 | 每个客户端配置页面 |
| ipset 条目数 | `ipset list client_1_proxy` |
| 系统资源 | `docker stats wg-easy` |

### 性能指标

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| 吞吐量 | >500 Mbps | iperf3 |
| 延迟 | <10ms | ping |
| DNS 查询 | <10ms | dig @10.8.0.1 |
| CPU 使用 | <30% | docker stats |
| 内存使用 | <1GB | docker stats |

---

## 🎓 高级用法

### 1. 多上游负载均衡（手动）

为不同客户端配置不同的上游实现简单的负载均衡：

```
客户端 1, 3, 5 → 上游 A
客户端 2, 4, 6 → 上游 B
```

### 2. 基于用途的分流

```
工作客户端:
  - 上游: Work Server
  - 规则: 公司域名、Google Workspace

个人客户端:
  - 上游: Personal Server
  - 规则: 社交媒体、流媒体
```

### 3. 时间段控制（通过禁用/启用）

```
工作时间 (9-18): 启用分流
下班时间: 禁用分流（全部直连）
```

---

## 🔄 维护操作

### 备份配置

```bash
# 备份数据库
docker exec wg-easy cp /etc/wireguard/wg-easy.db /etc/wireguard/wg-easy.db.backup

# 或从宿主机
docker cp wg-easy:/etc/wireguard/wg-easy.db ./backup/
```

### 恢复配置

```bash
# 恢复数据库
docker cp ./backup/wg-easy.db wg-easy:/etc/wireguard/wg-easy.db

# 重启服务
docker restart wg-easy
```

### 清理测试配置

```bash
# 进入容器
docker exec -it wg-easy bash

# 手动清理（谨慎使用）
# 停止上游接口
wg-quick down wg-up-1

# 清理 ipset
ipset destroy client_1_proxy

# 清理 iptables
iptables -t mangle -F PREROUTING

# 清理路由
ip rule del table 101
ip route flush table 101
```

---

## 📞 获取帮助

### 查看日志

```bash
# 查看所有日志
docker logs wg-easy

# 查看分流相关日志
docker logs wg-easy 2>&1 | grep SplitTunneling

# 实时查看
docker logs -f wg-easy
```

### 调试模式

```bash
# 启用详细日志
docker compose down
docker compose up -d -e DEBUG=*

# 查看所有调试信息
docker logs -f wg-easy
```

### 常用调试命令

```bash
# 进入容器
docker exec -it wg-easy bash

# 检查网络配置
wg show all brief
ipset list -n
iptables -t mangle -L -n -v
ip rule list
ip route show table 101

# 测试 DNS
dig @127.0.0.1 google.com

# 测试路由
ip route get 8.8.8.8 from 10.8.0.2
```

---

## 🎊 完成！

你现在已经掌握了 wg-easy 分流功能的使用方法！

**接下来**:
1. ✅ 创建你的第一个上游服务器
2. ✅ 为客户端配置分流规则
3. ✅ 测试验证功能
4. ✅ 根据需要调整和优化

**享受智能分流带来的便利！** 🚀

---

## 📚 相关文档

- **完整实施方案**: [SPLIT_TUNNELING_IMPLEMENTATION_PLAN.md](./SPLIT_TUNNELING_IMPLEMENTATION_PLAN.md)
- **代码实现**: [IMPLEMENTATION_EXAMPLES.md](./IMPLEMENTATION_EXAMPLES.md)
- **故障排查**: [QUICK_START_GUIDE.md](./QUICK_START_GUIDE.md) - 第 4 章
- **命令速查**: [QUICK_REFERENCE.md](./QUICK_REFERENCE.md)
- **实施完成报告**: [IMPLEMENTATION_COMPLETE.md](./IMPLEMENTATION_COMPLETE.md)

---

**版本**: v1.0.0  
**日期**: 2025-10-02  
**状态**: ✅ 可用
